#!/bin/bash

# Script di backup automatico per Catasto Storico\n# Creato: 2025-04-24 11:00:24\n\nBACKUP_DIR="C:\Users\saint\catasto"\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\nFILENAME="catasto_backup_completo_${TIMESTAMP}.sql"\nLOGFILE="backup_${TIMESTAMP}.log"\n\n# Creazione della directory di backup se non esiste\nmkdir -p ${BACKUP_DIR}\n\n# Esecuzione del backup\necho "Inizio backup: $(date)" > ${BACKUP_DIR}/${LOGFILE}\npg_dump -U postgres -d catasto_storico -f ${BACKUP_DIR}/${FILENAME} 2>> ${BACKUP_DIR}/${LOGFILE}\nRESULT=$?\n\n# Registrazione del backup nel database\nif [ $RESULT -eq 0 ]; then\n    echo "Backup completato con successo: $(date)" >> ${BACKUP_DIR}/${LOGFILE}\n    FILESIZE=$(stat -c%s "${BACKUP_DIR}/${FILENAME}")\n    psql -U postgres -d catasto_storico -c "SELECT registra_backup('${FILENAME}', 'backup_automatico', ${FILESIZE}, 'completo', TRUE, 'Backup completato con successo', '${BACKUP_DIR}/${FILENAME}');" >> ${BACKUP_DIR}/${LOGFILE}\nelse\n    echo "Errore durante il backup: $(date)" >> ${BACKUP_DIR}/${LOGFILE}\n    psql -U postgres -d catasto_storico -c "SELECT registra_backup('${FILENAME}', 'backup_automatico', NULL, 'completo', FALSE, 'Errore durante il backup', '${BACKUP_DIR}/${FILENAME}');" >> ${BACKUP_DIR}/${LOGFILE}\nfi\n\n# Rimozione backup vecchi (opzionale)\npsql -U postgres -d catasto_storico -c "CALL pulizia_backup_vecchi(30);" >> ${BACKUP_DIR}/${LOGFILE}\n\necho "Processo di backup terminato: $(date)" >> ${BACKUP_DIR}/${LOGFILE}\n